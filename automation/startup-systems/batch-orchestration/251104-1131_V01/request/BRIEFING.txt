================================================================================
  GPT SUMMARY: PROJECT CONTEXT OS STARTUP AUTOMATION
================================================================================

METADATA:
  Date: November 4, 2025
  Time: 11:31 AM
  Version: V01
  Category: automation/startup-systems/batch-orchestration
  Status: ✅ WORKING (with known limitations)
  Topic: Windows batch file orchestration for multi-service startup

================================================================================
  PROBLEM / GOAL
================================================================================

GOAL:
Create a single-click Windows batch file (start-all.bat) that:
  1. Automatically starts Docker Desktop if not running
  2. Starts 4 web services (MkDocs, Sourcegraph, Structurizr, Backstage)
  3. Runs all service terminals in the background (minimized)
  4. Shows a single aggregate debug/monitoring terminal
  5. Automatically opens all portal URLs in browser
  6. Cleans up any existing services before restarting
  7. Handles missing dependencies gracefully

The system is a "Project Context OS" - a 4-portal engineering workspace:
  - MkDocs (http://localhost:8000) - Documentation portal
  - Sourcegraph (http://localhost:7080) - Code search engine
  - Structurizr (http://localhost:8081) - Live C4 architecture diagrams
  - Backstage (http://localhost:3000) - Service catalog/developer portal

ENVIRONMENT:
  - Windows 11 (version 10.0.26200)
  - Docker Desktop (for Sourcegraph and Structurizr)
  - Python venv with MkDocs
  - Node.js with Yarn 4 for Backstage
  - PowerShell terminal
  - Workspace root: C:\DEV

================================================================================
  WHAT WORKS ✅
================================================================================

1. ✅ Docker Desktop auto-start with active polling
   - Detects if Docker is running
   - Launches Docker Desktop if not
   - Polls every 3 seconds (up to 2 minutes) until ready
   - Shows progress messages

2. ✅ All services start correctly in minimized windows
   - MkDocs: Python venv + mkdocs serve
   - Sourcegraph: docker compose up
   - Structurizr: docker run with volume mount
   - Backstage: node via Yarn 4

3. ✅ Aggregate monitor terminal
   - Shows live Docker container status
   - Displays recent logs from Sourcegraph and Structurizr
   - Refreshes every 5 seconds
   - Runs minimized, available in taskbar

4. ✅ Browser auto-open with delay
   - Waits 15 seconds for services to initialize
   - Opens all portals sequentially
   - Uses empty window title ("") to prevent URL misinterpretation

5. ✅ Prerequisite checking
   - Checks for Backstage Yarn (C:\DEV\backstage\.yarn\releases\yarn-4.4.1.cjs)
   - Checks for Python venv (C:\DEV\.venv\Scripts\activate.bat)
   - Skips services if dependencies missing
   - Shows helpful error messages with fix instructions

6. ✅ Cleanup before startup
   - Kills processes on ports 8000, 3000, 7007
   - Stops Docker containers (docker compose stop preserves data)
   - Removes old Structurizr containers
   - Closes related terminal windows by title
   - 2-second wait for clean shutdown

7. ✅ Backstage browser hijacking fix
   - Created start-backstage.bat wrapper
   - Sets BROWSER=none and BROWSER_ARGS=--no-sandbox
   - Prevents Backstage from auto-opening its own browser tab

8. ✅ Structurizr absolute path fix
   - Uses C:\DEV\docs\architecture\c4 instead of %cd%
   - %cd% doesn't expand correctly in cmd /k context
   - Absolute path ensures volume mount works

9. ✅ Data persistence
   - Changed from 'docker compose down' to 'docker compose stop'
   - Preserves Sourcegraph volumes (account data, settings)

================================================================================
  WHAT'S BROKEN / KNOWN ISSUES ❌
================================================================================

1. ❌ Backstage guest mode every time
   - User is "Guest" on every restart
   - No persistent authentication
   - REASON: Backstage uses in-memory auth in dev mode
   - FIX NEEDED: Add PostgreSQL backend and configure Backstage to use it
   - WORKAROUND: Accept guest mode for now, or manually set up DB

2. ❌ Cleanup can occasionally hang
   - The 'taskkill' loops can hang if no processes found
   - REASON: 'for /f' loops don't handle empty results gracefully
   - CURRENT: Simplified logic helps, but not 100% reliable
   - POTENTIAL FIX: Use PowerShell for cleanup instead of batch

3. ❌ Timing is finicky
   - 15-second browser delay works but isn't perfect
   - Backstage/Sourcegraph may not be fully ready
   - Users need to refresh pages occasionally
   - NO GOOD FIX: Services have variable startup times

4. ⚠️ Docker startup polling is aggressive
   - Polls every 3 seconds for up to 2 minutes
   - Works, but could be smarter (exponential backoff?)
   - Not a critical issue, just inefficient

5. ⚠️ No error recovery once running
   - If a service crashes after startup, script doesn't know
   - Monitor window shows logs but doesn't restart services
   - User must manually restart the whole system

================================================================================
  DETAILED ITERATION HISTORY
================================================================================

ITERATION 1: Basic script
  PROBLEM: Terminal opened and closed immediately
  CAUSE: Batch file exited before showing errors
  FIX: Added 'cmd /k' to keep windows open, added 'pause' commands

ITERATION 2: Docker detection
  PROBLEM: Script said to start Docker manually
  CAUSE: No logic to auto-start Docker
  FIX: Added Docker Desktop launcher + polling loop

ITERATION 3: Docker timing
  PROBLEM: Docker detection too fast (closed before Docker ready)
  CAUSE: No wait before first check
  FIX: Added 20-second initial wait, then 3-second polling

ITERATION 4: Docker timing v2
  PROBLEM: User wanted active checking, not blanket wait
  CAUSE: 20-second wait was too passive
  FIX: Removed initial wait, poll immediately every 3 seconds

ITERATION 5: Port conflicts
  PROBLEM: Structurizr port 8080 already in use, Backstage yarn missing
  CAUSE: Old containers running, missing prerequisites
  FIX: Added prerequisite checks, container cleanup

ITERATION 6: Structurizr cleanup
  PROBLEM: Port 8081 still in use after cleanup
  CAUSE: Only removing first Structurizr container
  FIX: Loop through ALL Structurizr containers

ITERATION 7: Backstage Yarn version
  PROBLEM: Global Yarn 1.22.22 conflicted with Backstage's Yarn 4
  CAUSE: Backstage uses Corepack + bundled Yarn 4.4.1
  FIX: Use Backstage's bundled Yarn directly

ITERATION 8: Backstage script name
  PROBLEM: 'yarn dev' not found
  CAUSE: Backstage package.json has 'start', not 'dev'
  FIX: Changed to 'yarn start'

ITERATION 9: Browser opening wrong port
  PROBLEM: Port 7007 opened (Backstage backend), not 3000 (frontend)
  CAUSE: Copied wrong port from earlier draft
  FIX: Changed to port 3000

ITERATION 10: Structurizr not opening
  PROBLEM: Docker container unhealthy, browser never opened 8081
  CAUSE: Volume mount using %cd% didn't expand correctly
  FIX: Changed to absolute path C:\DEV\docs\architecture\c4

ITERATION 11: Cleanup improvements
  PROBLEM: Terminal windows not closing on restart
  CAUSE: Generic taskkill not targeting specific windows
  FIX: Use 'tasklist /V /FI "WindowTitle=..."' to find PIDs by title

ITERATION 12: Monitor window visibility
  PROBLEM: Monitor window opened normally, user wanted minimized
  CAUSE: Didn't use 'start /min'
  FIX: Added 'start /min' to monitor-all.bat invocation

ITERATION 13: Browser opening twice
  PROBLEM: Port 3000 (Backstage) opened twice
  CAUSE: Backstage's 'yarn start' auto-opens browser
  FIX: Created start-backstage.bat wrapper to set BROWSER=none

ITERATION 14: Browser URL parsing
  PROBLEM: Windows misinterpreting some URLs as file paths
  CAUSE: 'start http://...' without empty title
  FIX: Added empty title: 'start "" http://...'

ITERATION 15: Cleanup hanging
  PROBLEM: Script sat frozen during cleanup
  CAUSE: Complex 'for /f' loops hung on empty results
  FIX: Simplified cleanup logic, added timeout

ITERATION 16: Data persistence
  PROBLEM: Sourcegraph account lost on restart
  CAUSE: 'docker compose down' removes volumes
  FIX: Changed to 'docker compose stop' (preserves volumes)

ITERATION 17: Final polish
  PROBLEM: All services running, but UX rough
  CAUSE: Various small issues
  FIX: Added status tracking (STRUCTURIZR_RUNNING), better messages

================================================================================
  CURRENT STATUS
================================================================================

WORKING SYSTEM:
  - start-all.bat: 256 lines
  - monitor-all.bat: 13 lines
  - start-backstage.bat: 5 lines
  - Desktop shortcut: "Start Project Context OS.lnk"

STARTUP TIME:
  - Docker: 20-30 seconds (if not already running)
  - MkDocs: 2-3 seconds (instant)
  - Sourcegraph: 2-3 minutes (heavy container)
  - Structurizr: 30-60 seconds (lighter container)
  - Backstage: 1-2 minutes (Yarn build)

USER EXPERIENCE:
  - Double-click shortcut
  - Watch status messages
  - Wait 15 seconds
  - All browsers open
  - Services run in background
  - Monitor available in taskbar
  - Refresh pages if needed

================================================================================
  MY ANALYSIS
================================================================================

ROOT CAUSES OF ISSUES:
1. Windows batch limitations:
   - Poor error handling
   - No native async/parallel execution
   - String/variable expansion quirks (%cd% in cmd /k)
   - 'for /f' loops fragile with empty input

2. Service startup timing unpredictable:
   - No standardized health check endpoints
   - Can't rely on fixed delays
   - Each service has different readiness signals

3. Backstage configuration complexity:
   - Yarn 4 vs Yarn 1 conflicts
   - Corepack adds indirection
   - Dev mode has limited auth options
   - Browser auto-open can't be disabled via CLI flag alone

4. Docker Desktop Windows integration:
   - No simple "is Docker ready?" command
   - 'docker info' is best we have
   - Slow cold start (20-30 seconds)

SUGGESTED IMPROVEMENTS:
1. ⭐ Rewrite in PowerShell:
   - Better error handling
   - Native async (Start-Job)
   - Easier to parse output
   - More reliable cleanup

2. ⭐ Add health check polling:
   - Don't just wait 15 seconds
   - Poll each service's health endpoint
   - Only open browser when ALL services healthy
   - Show per-service readiness status

3. ⭐ Implement proper Backstage auth:
   - Set up PostgreSQL container
   - Configure Backstage to use DB backend
   - Enable GitHub OAuth (or other SSO)
   - User stays logged in between restarts

4. ⭐ Add service monitoring:
   - Extend monitor-all.bat to check service health
   - Auto-restart crashed services
   - Send notifications if critical services down

5. ⭐ Create stop-all.bat:
   - User currently has to manually kill services
   - Stop script should gracefully shut down all services
   - Preserve data (stop, not down)

6. Consider Docker Compose for everything:
   - Sourcegraph: already uses compose
   - Structurizr: convert to compose
   - MkDocs: containerize it
   - Backstage: containerize it
   - BENEFIT: One docker compose up for everything
   - DOWNSIDE: MkDocs slow to containerize Python

7. Add logging:
   - Redirect service output to log files
   - Easier to debug issues
   - Don't rely on terminal windows

================================================================================
  WHAT TO ASK GPT
================================================================================

IMMEDIATE QUESTIONS:
1. How can I make the cleanup logic more robust in batch files?
   - Should I switch to PowerShell?
   - Is there a better way to handle empty 'for /f' results?

2. How do I add PostgreSQL to Backstage for persistent auth?
   - What's the minimal config?
   - Can I use Docker Compose to add PostgreSQL service?
   - What database schema does Backstage need?

3. Is there a way to poll service health without hardcoded delays?
   - Can I hit health endpoints and wait for 200 OK?
   - What's the best pattern in batch/PowerShell?

4. Should I containerize MkDocs and Backstage?
   - Pros/cons of full Docker Compose setup?
   - Performance implications?

FUTURE ENHANCEMENTS:
5. How to implement automatic service restart on crash?
   - Windows Service wrapper?
   - PowerShell background jobs with monitoring?
   - Docker restart policies?

6. How to add logging/telemetry?
   - Best practices for batch script logging?
   - Log aggregation across services?

7. How to make this cross-platform?
   - Can I make equivalent shell script for Linux/Mac?
   - Or just document Docker Compose approach?

================================================================================
  RELATED FILES
================================================================================

All related files are in the code/ folder:
  - start-all.bat (main orchestrator)
  - monitor-all.bat (aggregate debug terminal)
  - start-backstage.bat (Backstage wrapper)

Related documentation:
  - C:\DEV\README.md (Project Context OS overview)
  - C:\DEV\STATUS.md (Current system status)
  - C:\DEV\backstage\README.md (Backstage setup guide)
  - C:\DEV\sourcegraph\README.md (Sourcegraph troubleshooting)

Desktop shortcuts:
  - C:\Users\rtoth\Desktop\Start Project Context OS.lnk

================================================================================
  REPRODUCTION STEPS
================================================================================

TO REPRODUCE THE CURRENT WORKING STATE:
1. Ensure Docker Desktop installed
2. Ensure Python venv exists: C:\DEV\.venv
3. Ensure Backstage Yarn installed: cd C:\DEV\backstage && yarn install
4. Create C:\DEV\start-all.bat (see code/ folder)
5. Create C:\DEV\monitor-all.bat (see code/ folder)
6. Create C:\DEV\backstage\start-backstage.bat (see code/ folder)
7. Double-click start-all.bat (or use desktop shortcut)

TO REPRODUCE A SPECIFIC BUG:
  - Backstage guest mode: Just restart, always guest
  - Cleanup hanging: Run start-all.bat multiple times quickly
  - Browser opening twice: Comment out the start-backstage.bat wrapper

================================================================================
  CONSTRAINTS
================================================================================

TECHNICAL CONSTRAINTS:
  - Must be Windows batch (user prefers .bat over PowerShell for now)
  - Docker Desktop required (can't use Docker Engine alone)
  - All services must run locally (no cloud dependencies)
  - Services must persist data between restarts

USER PREFERENCES:
  - Single-click startup
  - All terminals minimized
  - Automatic browser opening
  - Clean shutdown/restart
  - No manual intervention needed

================================================================================
  SUCCESS CRITERIA
================================================================================

CURRENT STATE:
  ✅ Single-click startup works
  ✅ All services start reliably
  ✅ Terminals minimized
  ✅ Browsers open automatically
  ✅ Data persists
  ⚠️ Occasional cleanup hang
  ❌ Backstage guest mode every time

IDEAL STATE:
  ✅ Everything above
  ✅ Zero cleanup hangs
  ✅ Backstage persistent login
  ✅ Health check-based browser opening (not fixed delay)
  ✅ Auto-restart on service crash
  ✅ stop-all.bat for clean shutdown

================================================================================
  END OF BRIEFING
================================================================================
