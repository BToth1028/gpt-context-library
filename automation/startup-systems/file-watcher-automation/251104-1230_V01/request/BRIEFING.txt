**Target path:** C:\DEV\docs\gpt\automation\startup-systems\file-watcher-automation\251104-1230_V01\response

================================================================================
GPT BRIEFING: PowerShell File Watcher Auto-Exit Issue
================================================================================

DATE: 2025-11-04
TIME: 12:30
VERSION: V01
STATUS: Needs GPT Review
CATEGORY: automation/startup-systems/file-watcher-automation

================================================================================
PROBLEM STATEMENT
================================================================================

We have a PowerShell FileSystemWatcher script that monitors the Downloads folder
for GPT_RESPONSE.md files. The script should:

1. Start when a GPT briefing is created
2. Monitor Downloads folder
3. When GPT_RESPONSE.md appears:
   - Read **Target path:** header from the file
   - Move file to that target path
   - Display Windows notification
   - **Automatically exit after successful move**

CURRENT ISSUE:
- Script starts successfully (confirmed via terminal output)
- Shows "Watcher started (one-shot mode)"
- Shows correct source path and pattern
- BUT: Does NOT detect the test file when it's created
- File remains in Downloads, never gets moved
- Watcher does not exit (as expected, since it never detected the file)

================================================================================
WHAT WORKS ✅
================================================================================

1. **Watcher startup**: Script starts without errors
2. **Logging system**: Timestamps and color-coded messages working
3. **Path configuration**: Source path (Downloads) is correct
4. **Pattern matching**: Set to "GPT_RESPONSE.md" (exact match)

Terminal output shows:
```
[2025-11-04 12:27:57] INFO: Watcher started (one-shot mode)
[2025-11-04 12:27:57] INFO: Source: C:\Users\rtoth\Downloads
[2025-11-04 12:27:57] INFO: Pattern: GPT_RESPONSE.md
[2025-11-04 12:27:57] INFO: Waiting for GPT_RESPONSE.md file...
[2025-11-04 12:27:57] INFO: Will automatically exit after moving file
```

================================================================================
WHAT DOESN'T WORK ❌
================================================================================

1. **File detection**: FileSystemWatcher's Created event never fires
2. **File movement**: Test file never moves from Downloads to target
3. **Auto-exit**: Watcher stays running (waiting for file that it's not seeing)

Test file was created with:
```powershell
Set-Content -Path "$env:USERPROFILE\Downloads\GPT_RESPONSE.md" -Value @"
**Target path:** C:\DEV\docs\gpt\automation\startup-systems\batch-orchestration\251104-1150_V02\response

# Test GPT Response

This is a test to verify one-shot mode.
"@
```

Result: File created successfully in Downloads, but watcher never detected it.

================================================================================
WHAT WE'RE TRYING TO ACHIEVE
================================================================================

**Workflow Goal**:
1. User asks for GPT summary → I create briefing folders and files
2. I run sync-gpt-repo.ps1 which:
   - Commits to GitHub
   - **Automatically starts watcher** (kills any old instances)
   - Provides ChatGPT prompt to user
3. User sends prompt to ChatGPT
4. ChatGPT saves GPT_RESPONSE.md (with **Target path:** header) to Downloads
5. Watcher detects file → moves it → exits
6. User continues working without manual file management

**Critical Requirements**:
- One-shot mode: Start when needed, move file, exit automatically
- No manual file moving or script management
- Robust detection of new files in Downloads
- Parse target path from file content
- Graceful error handling

================================================================================
DETAILED ANALYSIS
================================================================================

**Possible Root Causes**:

1. **Timing Issue**: File created before watcher fully initialized?
   - Watcher uses Register-ObjectEvent which may have startup delay
   - Test created file immediately after starting watcher

2. **Event Type Issue**: Using "Created" event, but should we use "Changed"?
   - Some file operations don't trigger "Created"
   - PowerShell's Set-Content might trigger different events

3. **Path Resolution**: Downloads path might be symbolic link or junction?
   - Watcher monitoring: C:\Users\rtoth\Downloads
   - File created at: $env:USERPROFILE\Downloads\GPT_RESPONSE.md
   - These should resolve to same path, but FileSystemWatcher is picky

4. **Event Handler Scope**: Event handler runs in different scope
   - Uses script re-import: `Get-Content $using:scriptPath -Raw`
   - Invokes with: `Invoke-Expression $scriptContent`
   - This is complex and error-prone

5. **Notification Timing**: $global:fileMovedSuccessfully flag
   - Event handler sets this, main loop checks it
   - Race condition or scope isolation issue?

================================================================================
CURRENT IMPLEMENTATION
================================================================================

See attached code files:
- gpt-response-watcher.ps1 (main watcher script)
- sync-gpt-repo.ps1 (starts watcher automatically)
- start-gpt-watcher.bat (manual start wrapper)

Key sections of gpt-response-watcher.ps1:

**Watcher Setup**:
```powershell
$fsw = New-Object IO.FileSystemWatcher $Source, $Pattern
$fsw.IncludeSubdirectories = $false
$fsw.EnableRaisingEvents = $true
```

**Event Handler**:
```powershell
Register-ObjectEvent $fsw Created -Action {
    $path = $Event.SourceEventArgs.FullPath

    # Re-import functions
    $scriptContent = Get-Content $using:scriptPath -Raw
    Invoke-Expression $scriptContent

    # Move file and check result
    $result = Move-WithRetry $path

    if ($result) {
        $global:fileMovedSuccessfully = $true
    }
} | Out-Null
```

**Main Loop** (waits for file move, then exits):
```powershell
while (-not $global:fileMovedSuccessfully -and $elapsed -lt $timeout) {
    Start-Sleep -Seconds 1
    $elapsed++
}

if ($global:fileMovedSuccessfully) {
    Log "File moved successfully. Shutting down watcher." "SUCCESS"
} else {
    Log "Timeout reached without receiving file. Shutting down watcher." "WARN"
}

$fsw.Dispose()
```

================================================================================
SUGGESTED IMPROVEMENTS FROM AI (YOUR RECOMMENDATIONS)
================================================================================

1. **Simplify event handler scope issues**
   - Avoid Invoke-Expression and script re-import
   - Define functions before Register-ObjectEvent
   - Or use a simpler inline handler

2. **Add multiple event types**
   - Monitor Created, Changed, and Renamed
   - Different file creation methods trigger different events

3. **Add immediate file check**
   - Before starting watcher loop, check if file already exists
   - Handles race condition where file created before watcher ready

4. **Add debug logging in event handler**
   - Log when event fires
   - Log the full path detected
   - Log any errors in event handler (currently swallowed)

5. **Test event registration**
   - Add a verification that event handler actually registered
   - PowerShell silent failure is common with Register-ObjectEvent

6. **Alternative approach: Polling instead of events**
   - Simple loop checking for file existence
   - More reliable than FileSystemWatcher events
   - Trade-off: Slightly higher CPU (negligible for 1-second checks)

================================================================================
SPECIFIC QUESTIONS FOR GPT
================================================================================

1. **Why doesn't FileSystemWatcher detect Set-Content file creation?**
   - Is this a known PowerShell issue?
   - Do we need different events or filters?

2. **Is the event handler scope/re-import pattern correct?**
   - Is there a simpler way to access functions in event handlers?
   - Should we use a different pattern entirely?

3. **Should we use polling instead of FileSystemWatcher?**
   - What are the pros/cons for this one-shot use case?
   - Sample implementation?

4. **How to debug FileSystemWatcher events?**
   - How to log inside the event handler reliably?
   - How to verify events are actually firing?

5. **Best practices for one-shot watchers in PowerShell?**
   - Is there a better architecture for "watch once and exit"?

================================================================================
RELATED FILES
================================================================================

In code/ folder:
- gpt-response-watcher.ps1 (main watcher, 192 lines)
- sync-gpt-repo.ps1 (starts watcher automatically)
- start-gpt-watcher.bat (manual wrapper)

In zip/ folder:
- Flattened copies of all files for easy import to GPT

================================================================================
REPRODUCTION STEPS
================================================================================

1. Start watcher:
   ```
   powershell -File C:\DEV\scripts\gpt-response-watcher.ps1
   ```

2. In another terminal, create test file:
   ```powershell
   Set-Content -Path "$env:USERPROFILE\Downloads\GPT_RESPONSE.md" -Value @"
   **Target path:** C:\DEV\docs\gpt\automation\startup-systems\batch-orchestration\251104-1150_V02\response

   # Test Response
   Test content here
   "@
   ```

3. Expected: File moves, watcher logs success and exits
4. Actual: File stays in Downloads, watcher keeps running silently

================================================================================
CONSTRAINTS
================================================================================

- Must work on Windows 10/11 with PowerShell 5.1+
- No external dependencies (pure PowerShell)
- Must handle files being opened by other processes (retry logic)
- Must parse **Target path:** from file content (this part works in isolation)
- Should minimize resource usage (hence one-shot design)
- Must provide user feedback (logs, notifications)

================================================================================
SUCCESS CRITERIA
================================================================================

✅ Watcher detects GPT_RESPONSE.md when created in Downloads
✅ Reads **Target path:** header correctly
✅ Moves file to specified path
✅ Shows Windows notification
✅ Automatically exits after successful move
✅ Handles errors gracefully (logs, doesn't crash)
✅ Works reliably when started by sync-gpt-repo.ps1

================================================================================
CONTEXT
================================================================================

This is part of a larger "Project Context OS" system that manages AI
consultation workflows. The watcher is a critical piece that eliminates
manual file management when ChatGPT provides responses.

Related systems:
- GPT briefing system (3-tier versioned folder structure)
- Public gpt-context-library GitHub repo
- sync-gpt-repo.ps1 orchestration script

User expects: "Create briefing → Send to ChatGPT → Response auto-saves"
Current state: Everything works except the auto-save (this watcher)

================================================================================
END OF BRIEFING
================================================================================
